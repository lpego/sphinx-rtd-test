<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image segmentation &mdash; mzbsuite 0.0.1 alpha documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Skeletonization unsupervised" href="skeletonization_unsupervised.html" />
    <link rel="prev" title="Configuration" href="../configuration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            mzbsuite
              <img src="../../_static/mzbsuite_logo_v2.1.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Project Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow_models.html">Workflow and Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Image segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="skeletonization_unsupervised.html">Skeletonization unsupervised</a></li>
<li class="toctree-l1"><a class="reference internal" href="skeletonization_supervised_inference.html">Skeletonization: supervised, inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_inference.html">Classification: inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_finetune.html">Classification: finetune</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Processing scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scripts/processing_scripts.html">Processing scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scripts/diverse_preprocessing.html">Other scripts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">mzb-suite Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/mzbsuite.html"><code class="docutils literal notranslate"><span class="pre">mzbsuite</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mzbsuite.html#functions-and-docstrings">Functions and docstrings</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mzbsuite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Image segmentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/files/examples/segmentation.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Image-segmentation">
<h1>Image segmentation<a class="headerlink" href="#Image-segmentation" title="Permalink to this heading"></a></h1>
<p>In this notebook we illustrate how to use the script <code class="docutils literal notranslate"><span class="pre">scripts/image_parsing/main_raw_to_clips.py</span></code> to segment (i.e. extract) clips containing a single organisms from large-pane images containing multiple organisms.</p>
<p>As a first, step, import the necessary packages, including the custom functions of this repository <code class="docutils literal notranslate"><span class="pre">msbsuite.utils</span></code> (if you have trouble importing this package, refer back to the <code class="docutils literal notranslate"><span class="pre">Installation</span></code> section of the documentation).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">feature</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">morphology</span><span class="p">,</span> <span class="n">segmentation</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">mzbsuite.utils</span> <span class="kn">import</span> <span class="n">cfg_to_arguments</span>

<span class="kn">from</span> <span class="nn">notebook.services.config</span> <span class="kn">import</span> <span class="n">ConfigManager</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;limit_output&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
</pre></div>
</div>
</div>
<p>We now need to declare the parameters to tell the script where to find the files and where to save its outputs. In this notebook, we pass these arguments as a dictionary to Python, rather than variables in a shell (<code class="docutils literal notranslate"><span class="pre">.sh</span></code>) script.</p>
<p>You need to have downloaded the example dataset in order for this cell to compile properly. Alternatively you can change the file paths to the locations of folders of your own dataset on the <code class="docutils literal notranslate"><span class="pre">arguments</span> <span class="pre">=</span> <span class="pre">{}</span></code> block; the path is relative to where this notebook is located.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/data/shared/mzb-workflow/docs&quot;</span><span class="p">)</span>

<span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;input_dir&quot;</span><span class="p">:</span> <span class="n">ROOT_DIR</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;data/mzb_example_data/raw_img/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">ROOT_DIR</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;data/derived/mzb_example_data/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;save_full_mask_dir&quot;</span><span class="p">:</span> <span class="n">ROOT_DIR</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;data/derived/mzb_example_data/full_image_masks/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;config_file&quot;</span><span class="p">:</span> <span class="n">ROOT_DIR</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;configs/configuration_flume_datasets.yaml&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;config_file&quot;</span><span class="p">]),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

<span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;trcl_gpu_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># this sets the number of available GPUs to zero, since this script doesn&#39;t benefit from GPU compute.</span>
<span class="n">cfg</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cfg</span></code> variable should display a portion of the list of parameters in the configuration file.</p>
<p>Now we use custom function <code class="docutils literal notranslate"><span class="pre">cfg_to_arguments</span></code> to parse the parameters we have just supplied and the parameters in the configuration file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">cfg_to_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg_to_arguments</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Now we check whether the output directories already exist, and if not create them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define paths</span>
<span class="n">main_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_dir</span><span class="p">)</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
<span class="n">outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Parse the contents of the input folder and standardise filenames, and print how many images are going to be processed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get list of files to process</span>
<span class="n">files_proc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">main_root</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*.</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_image_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="c1"># make sure weird capitalization doesn&#39;t cause issues</span>
<span class="n">files_proc</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">main_root</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/*.</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_image_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)))</span>
<span class="n">files_proc</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">files_proc</span> <span class="k">if</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
<span class="n">files_proc</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_proc</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If a clip area is defined, for instance if there is a reference scale in the same spot in all the images, this area is earmarked for exclusion in later processing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_clip_areas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">location_cutout</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_clip_areas</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">PLOTS</span></code> variable is True, then the script will print out a summary plot for each image and for each individual clip being generated. If you don’t want plots being generated, change the value to False. If you would like to save each plot as a file, you can uncomment (i.e. remove <code class="docutils literal notranslate"><span class="pre">#</span></code>) the lines <code class="docutils literal notranslate"><span class="pre">plt.savefig()</span></code> in the loop below.</p>
<blockquote>
<div><p>⚠️ WARNING: this can be computationally intensive and can potentially crash the notebook if a large number number of outputs is generated!</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PLOTS</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Define a normalisation function to flatten the pixel values of images (this helps with downstream processing).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define quick normalization function</span>
<span class="n">norm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Below is the main loop that processes the images into clips, and will also produce figures if <code class="docutils literal notranslate"><span class="pre">PLOTS</span> <span class="pre">=</span> <span class="pre">True</span></code>. If <code class="docutils literal notranslate"><span class="pre">PLOTS</span> <span class="pre">=</span> <span class="pre">False</span></code>, the script will save a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file with information about each image and clips generated from it, as well as other information such as bounding box coordinates, pixel areas of the mask, etc.</p>
<p>For further details about the logic fo this script please refer to the explanation in the section <code class="docutils literal notranslate"><span class="pre">Segmentation</span></code> under <code class="docutils literal notranslate"><span class="pre">Processing</span> <span class="pre">scripts</span></code> in the documentation.</p>
<blockquote>
<div><p>⚠️ WARNING: depending on the number of images and how many organisms are present, the processing time of the loop can be considerable.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ### ATTEMPT AT UPDATING THE FIGURE IN-PLACE, INSTEAD OF GENERATING NEW FIGURES ALL THE TIME...</span>

<span class="c1"># import numpy as np</span>
<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># from IPython.display import display, clear_output</span>

<span class="c1"># fig = plt.figure()</span>
<span class="c1"># ax = fig.add_subplot(1, 1, 1)</span>

<span class="c1"># for i in range(21):</span>
<span class="c1">#     ax.set_xlim(0, 20)</span>

<span class="c1">#     ax.plot(i, 1, marker=&#39;x&#39;)</span>
<span class="c1">#     display(fig)</span>

<span class="c1">#     clear_output(wait = True)</span>
<span class="c1">#     plt.pause(0.5)</span>

<span class="c1"># # ?display</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### EXPERIMENTING WITH clear_output...</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">uniform</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>

<span class="k">def</span> <span class="nf">black_box</span><span class="p">():</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Score: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">black_box</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files_proc</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">files_proc</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>

    <span class="n">mask_props</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1"># get image path</span>
    <span class="n">raw_image_in</span> <span class="o">=</span> <span class="n">fo</span>
    <span class="n">full_path_raw_image_in</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="c1"># read image and convert to HSV</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">full_path_raw_image_in</span><span class="p">))[:,</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
    <span class="n">im_t</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">im_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hsv</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># filter image with some iterations of gaussian blur</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_gaussian_blur_passes</span><span class="p">):</span>
        <span class="n">im_t</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">im_t</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_gaussian_blur</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># prepare for morphological reconstruction</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im_t</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_t</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im_t</span><span class="p">)</span>

    <span class="c1"># remove the background</span>
    <span class="n">dil</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">reconstruction</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">im_t</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dilation&quot;</span><span class="p">)</span>
    <span class="n">im_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_t</span> <span class="o">-</span> <span class="n">dil</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># adaptive local thresholding of foreground vs background</span>
    <span class="c1"># weighted cross correlation with gaussian filter</span>
    <span class="n">ad_thresh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span>
        <span class="n">im_t</span><span class="p">,</span>
        <span class="mi">255</span><span class="p">,</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">impa_adaptive_threshold_block_size</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># additional global threhsold to remove foreground vs background</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">im_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_OTSU</span><span class="p">)</span>

    <span class="c1"># merge thresholds to globally get foreground masks</span>
    <span class="c1"># thresh = thresh | ad_thresh</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh</span> <span class="o">+</span> <span class="n">ad_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># postprocess masking to remove small objects and fill holes</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_mask_postprocess_kernel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_mask_postprocess_passes</span><span class="p">):</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span>
        <span class="p">)</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">kernel</span>
        <span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>

    <span class="c1"># cut out area related to measurement/color calibration widget</span>
    <span class="k">if</span> <span class="s2">&quot;project_portable_flume&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_root</span><span class="p">):</span>
        <span class="n">thresh</span><span class="p">[</span><span class="n">location_cutout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:,</span> <span class="n">location_cutout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># get labels of connected components</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PLOTS</span><span class="p">:</span>
        <span class="n">full_image_thresh_fig</span><span class="p">,</span> <span class="n">full_image_thresh_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;global threshold&#39;</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ad_thresh</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;adaptive threshold&#39;</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;original rgb&#39;</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">full_image_thresh_ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># plt.savefig(&quot;test.png&quot;)</span>

    <span class="c1"># Save the labels as a jpg for the full image</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_full_mask_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;labels_</span><span class="si">{</span><span class="n">fo</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_save_clips_plus_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping clip generation&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="c1"># get region properties</span>
    <span class="n">rprop</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">thresh</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>

    <span class="c1"># init some stuff</span>
    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># loop through identified regions and get some properties</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rprop</span><span class="p">)):</span>  <span class="c1"># np.unique(labels):</span>

        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">reg_pro</span> <span class="o">=</span> <span class="n">rprop</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

        <span class="c1"># skip background</span>
        <span class="k">if</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># skip small objects</span>
        <span class="k">if</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_area_threshold</span><span class="p">:</span>  <span class="c1"># 5000 defauilt</span>
            <span class="k">continue</span>

        <span class="c1"># get mask for current region of interest</span>
        <span class="n">current_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">thresh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">current_mask</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># coordinates of bounding box corners for current region of interest</span>
        <span class="p">(</span>
            <span class="n">min_row</span><span class="p">,</span>
            <span class="n">min_col</span><span class="p">,</span>
            <span class="n">max_row</span><span class="p">,</span>
            <span class="n">max_col</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">bbox</span>  <span class="c1"># cv2.boundingRect(approx)</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_col</span><span class="p">,</span> <span class="n">min_row</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">-</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span> <span class="o">-</span> <span class="n">min_row</span><span class="p">)</span>

        <span class="c1"># get the bounding box with some buffer</span>
        <span class="p">(</span><span class="n">x_e</span><span class="p">,</span> <span class="n">y_e</span><span class="p">,</span> <span class="n">w_e</span><span class="p">,</span> <span class="n">h_e</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_bounding_box_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_bounding_box_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="n">w</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_bounding_box_buffer</span><span class="p">,</span>
            <span class="n">h</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">impa_bounding_box_buffer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">PLOTS</span><span class="p">:</span>
            <span class="n">clip_crop_fig</span><span class="p">,</span> <span class="n">clip_crop_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">clip_crop_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x_e</span><span class="p">,</span> <span class="n">y_e</span><span class="p">),</span> <span class="n">w_e</span><span class="p">,</span> <span class="n">h_e</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">clip_crop_ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

            <span class="c1"># clear_output(wait = True)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">full_image_thresh_fig</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="c1"># plt.savefig(f&quot;test_mask{c}.png&quot;)</span>
            <span class="c1"># exit()</span>

        <span class="c1"># get the crop of the image and the mask</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y_e</span> <span class="p">:</span> <span class="n">y_e</span> <span class="o">+</span> <span class="n">h_e</span><span class="p">,</span> <span class="n">x_e</span> <span class="p">:</span> <span class="n">x_e</span> <span class="o">+</span> <span class="n">w_e</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="n">crop_hsv</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[</span><span class="n">y_e</span> <span class="p">:</span> <span class="n">y_e</span> <span class="o">+</span> <span class="n">h_e</span><span class="p">,</span> <span class="n">x_e</span> <span class="p">:</span> <span class="n">x_e</span> <span class="o">+</span> <span class="n">w_e</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">crop_mask</span> <span class="o">=</span> <span class="n">current_mask</span><span class="p">[</span><span class="n">y_e</span> <span class="p">:</span> <span class="n">y_e</span> <span class="o">+</span> <span class="n">h_e</span><span class="p">,</span> <span class="n">x_e</span> <span class="p">:</span> <span class="n">x_e</span> <span class="o">+</span> <span class="n">w_e</span><span class="p">]</span>
        <span class="n">crop_im_t</span> <span class="o">=</span> <span class="n">im_t</span><span class="p">[</span><span class="n">y_e</span> <span class="p">:</span> <span class="n">y_e</span> <span class="o">+</span> <span class="n">h_e</span><span class="p">,</span> <span class="n">x_e</span> <span class="p">:</span> <span class="n">x_e</span> <span class="o">+</span> <span class="n">w_e</span><span class="p">]</span>

        <span class="n">im_crop_m</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span>
            <span class="n">crop_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
            <span class="p">:,</span>
        <span class="p">]</span>
        <span class="n">hsv_crop_m</span> <span class="o">=</span> <span class="n">crop_hsv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span>
            <span class="n">crop_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
            <span class="p">:,</span>
        <span class="p">]</span>

        <span class="c1"># save actual image and mask crops</span>
        <span class="c1"># Avoid &quot;invalid value encountered in true_divide&quot; warning</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fo</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_mask.</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_image_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">crop_mask</span> <span class="o">/</span> <span class="n">crop_mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">IMWRITE_JPEG_QUALITY</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># reactivate warnings</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fo</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_rgb.</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">impa_image_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="n">crop</span><span class="p">,</span>
            <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">IMWRITE_JPEG_QUALITY</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># get average color of the crop</span>
        <span class="c1"># not really needed, aren&#39;t they</span>
        <span class="c1"># im_crop_cmean = str(np.mean(im_crop_m, axis=0))</span>
        <span class="c1"># hsv_crop_cmean = str(np.mean(hsv_crop_m, axis=0))</span>

        <span class="c1"># im_crop_std = str(np.std(im_crop_m, axis=0))</span>
        <span class="c1"># hsv_crop_std = str(np.std(hsv_crop_m, axis=0))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">current_mask</span> <span class="o">*</span> <span class="n">c</span>

        <span class="k">if</span> <span class="n">PLOTS</span><span class="p">:</span>
            <span class="n">clip_fig</span><span class="p">,</span> <span class="n">clip_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">crop</span><span class="p">)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;crop&#39;</span><span class="p">)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">reg_pro</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># crop_mask)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;binary mask&#39;</span><span class="p">)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">crop</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">crop_mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;mask HSV&#39;</span><span class="p">)</span>
            <span class="n">im_t_crop_m</span> <span class="o">=</span> <span class="n">crop_im_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span>
                <span class="n">crop_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                <span class="p">:,</span>
            <span class="p">]</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">im_t_crop_m</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">clip_ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;colour histogram&#39;</span><span class="p">)</span>
            <span class="c1"># plt.pause(1)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">sub_df</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_image_in</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_image_in</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;png_mask_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;reg_lab&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">label</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;squareness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="c1"># sub_df[&quot;average_color&quot;] = im_crop_cmean</span>
        <span class="c1"># sub_df[&quot;average_color_std&quot;] = im_crop_std</span>
        <span class="c1"># sub_df[&quot;average_hsv&quot;] = hsv_crop_cmean</span>
        <span class="c1"># sub_df[&quot;average_hsv_std&quot;] = hsv_crop_std</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;tight_bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;large_bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x_e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y_e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">w_e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">h_e</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;ell_minor_axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">minor_axis_length</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;ell_major_axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">major_axis_length</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;bbox_area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">bbox_area</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;area_px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_pro</span><span class="o">.</span><span class="n">area</span>
        <span class="n">sub_df</span><span class="p">[</span><span class="s2">&quot;mask_centroid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">reg_pro</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sub_df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">mask_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_df</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">PLOTS</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">mask_props</span><span class="p">:</span>
        <span class="n">mask_props</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mask_props</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
        <span class="n">mask_props</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s2">&quot;_mask_properties.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../configuration.html" class="btn btn-neutral float-left" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="skeletonization_unsupervised.html" class="btn btn-neutral float-right" title="Skeletonization unsupervised" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-08-01 Michele Volpi, Luca Pegoraro, Blake Matthews, Catherine Graham.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>